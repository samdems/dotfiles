"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const assert = require("assert");
const convert_1 = require("../convert");
class CodeActionAdapter {
    // Returns a {Boolean} indicating this adapter can adapt the server based on the
    // given serverCapabilities.
    static canAdapt(serverCapabilities) {
        return serverCapabilities.codeActionProvider === true;
    }
    // Public: Retrieves code actions for a given editor, range, and context (diagnostics).
    // Throws an error if codeActionProvider is not a registered capability.
    //
    // * `connection` A {LanguageClientConnection} to the language server that provides highlights.
    // * `serverCapabilities` The {ServerCapabilities} of the language server that will be used.
    // * `editor` The Atom {TextEditor} containing the diagnostics.
    // * `range` The Atom {Range} to fetch code actions for.
    // * `diagnostics` An {Array<atomIde$Diagnostic>} to fetch code actions for.
    //                 This is typically a list of diagnostics intersecting `range`.
    //
    // Returns a {Promise} of an {Array} of {atomIde$CodeAction}s to display.
    static getCodeActions(connection, serverCapabilities, linterAdapter, editor, range, diagnostics) {
        return __awaiter(this, void 0, void 0, function* () {
            if (linterAdapter == null) {
                return [];
            }
            assert(serverCapabilities.codeActionProvider, 'Must have the textDocument/codeAction capability');
            const commands = yield connection.codeAction({
                textDocument: convert_1.default.editorToTextDocumentIdentifier(editor),
                range: convert_1.default.atomRangeToLSRange(range),
                context: {
                    diagnostics: diagnostics.map((diagnostic) => {
                        // Retrieve the stored diagnostic code if it exists.
                        // Until the Linter API provides a place to store the code,
                        // there's no real way for the code actions API to give it back to us.
                        const converted = convert_1.default.atomIdeDiagnosticToLSDiagnostic(diagnostic);
                        if (diagnostic.range != null && diagnostic.text != null) {
                            const code = linterAdapter.getDiagnosticCode(editor, diagnostic.range, diagnostic.text);
                            if (code != null) {
                                converted.code = code;
                            }
                        }
                        return converted;
                    }),
                },
            });
            return commands.map((command) => ({
                apply() {
                    return __awaiter(this, void 0, void 0, function* () {
                        yield connection.executeCommand({
                            command: command.command,
                            arguments: command.arguments,
                        });
                    });
                },
                getTitle() {
                    return Promise.resolve(command.title);
                },
                // tslint:disable-next-line:no-empty
                dispose() { },
            }));
        });
    }
}
exports.default = CodeActionAdapter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZS1hY3Rpb24tYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGFwdGVycy9jb2RlLWFjdGlvbi1hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFFQSxpQ0FBa0M7QUFDbEMsd0NBQWlDO0FBVWpDO0lBQ0UsZ0ZBQWdGO0lBQ2hGLDRCQUE0QjtJQUNyQixNQUFNLENBQUMsUUFBUSxDQUFDLGtCQUFzQztRQUMzRCxPQUFPLGtCQUFrQixDQUFDLGtCQUFrQixLQUFLLElBQUksQ0FBQztJQUN4RCxDQUFDO0lBRUQsdUZBQXVGO0lBQ3ZGLHdFQUF3RTtJQUN4RSxFQUFFO0lBQ0YsK0ZBQStGO0lBQy9GLDRGQUE0RjtJQUM1RiwrREFBK0Q7SUFDL0Qsd0RBQXdEO0lBQ3hELDRFQUE0RTtJQUM1RSxnRkFBZ0Y7SUFDaEYsRUFBRTtJQUNGLHlFQUF5RTtJQUNsRSxNQUFNLENBQU8sY0FBYyxDQUNoQyxVQUFvQyxFQUNwQyxrQkFBc0MsRUFDdEMsYUFBOEMsRUFDOUMsTUFBa0IsRUFDbEIsS0FBWSxFQUNaLFdBQWlDOztZQUVqQyxJQUFJLGFBQWEsSUFBSSxJQUFJLEVBQUU7Z0JBQ3pCLE9BQU8sRUFBRSxDQUFDO2FBQ1g7WUFDRCxNQUFNLENBQUMsa0JBQWtCLENBQUMsa0JBQWtCLEVBQUUsa0RBQWtELENBQUMsQ0FBQztZQUNsRyxNQUFNLFFBQVEsR0FBRyxNQUFNLFVBQVUsQ0FBQyxVQUFVLENBQUM7Z0JBQzNDLFlBQVksRUFBRSxpQkFBTyxDQUFDLDhCQUE4QixDQUFDLE1BQU0sQ0FBQztnQkFDNUQsS0FBSyxFQUFFLGlCQUFPLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDO2dCQUN4QyxPQUFPLEVBQUU7b0JBQ1AsV0FBVyxFQUFFLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRTt3QkFDMUMsb0RBQW9EO3dCQUNwRCwyREFBMkQ7d0JBQzNELHNFQUFzRTt3QkFDdEUsTUFBTSxTQUFTLEdBQUcsaUJBQU8sQ0FBQywrQkFBK0IsQ0FBQyxVQUFVLENBQUMsQ0FBQzt3QkFDdEUsSUFBSSxVQUFVLENBQUMsS0FBSyxJQUFJLElBQUksSUFBSSxVQUFVLENBQUMsSUFBSSxJQUFJLElBQUksRUFBRTs0QkFDdkQsTUFBTSxJQUFJLEdBQUcsYUFBYSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxVQUFVLENBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQzs0QkFDeEYsSUFBSSxJQUFJLElBQUksSUFBSSxFQUFFO2dDQUNoQixTQUFTLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQzs2QkFDdkI7eUJBQ0Y7d0JBQ0QsT0FBTyxTQUFTLENBQUM7b0JBQ25CLENBQUMsQ0FBQztpQkFDSDthQUNGLENBQUMsQ0FBQztZQUNILE9BQU8sUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFDMUIsS0FBSzs7d0JBQ1QsTUFBTSxVQUFVLENBQUMsY0FBYyxDQUFDOzRCQUM5QixPQUFPLEVBQUUsT0FBTyxDQUFDLE9BQU87NEJBQ3hCLFNBQVMsRUFBRSxPQUFPLENBQUMsU0FBUzt5QkFDN0IsQ0FBQyxDQUFDO29CQUNMLENBQUM7aUJBQUE7Z0JBQ0QsUUFBUTtvQkFDTixPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUN4QyxDQUFDO2dCQUNELG9DQUFvQztnQkFDcEMsT0FBTyxLQUFJLENBQUM7YUFDYixDQUFDLENBQUMsQ0FBQztRQUNOLENBQUM7S0FBQTtDQUNGO0FBL0RELG9DQStEQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGF0b21JZGUgZnJvbSAnYXRvbS1pZGUnO1xyXG5pbXBvcnQgTGludGVyUHVzaFYyQWRhcHRlciBmcm9tICcuL2xpbnRlci1wdXNoLXYyLWFkYXB0ZXInO1xyXG5pbXBvcnQgYXNzZXJ0ID0gcmVxdWlyZSgnYXNzZXJ0Jyk7XHJcbmltcG9ydCBDb252ZXJ0IGZyb20gJy4uL2NvbnZlcnQnO1xyXG5pbXBvcnQge1xyXG4gIExhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbixcclxuICBTZXJ2ZXJDYXBhYmlsaXRpZXMsXHJcbn0gZnJvbSAnLi4vbGFuZ3VhZ2VjbGllbnQnO1xyXG5pbXBvcnQge1xyXG4gIFRleHRFZGl0b3IsXHJcbiAgUmFuZ2UsXHJcbn0gZnJvbSAnYXRvbSc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb2RlQWN0aW9uQWRhcHRlciB7XHJcbiAgLy8gUmV0dXJucyBhIHtCb29sZWFufSBpbmRpY2F0aW5nIHRoaXMgYWRhcHRlciBjYW4gYWRhcHQgdGhlIHNlcnZlciBiYXNlZCBvbiB0aGVcclxuICAvLyBnaXZlbiBzZXJ2ZXJDYXBhYmlsaXRpZXMuXHJcbiAgcHVibGljIHN0YXRpYyBjYW5BZGFwdChzZXJ2ZXJDYXBhYmlsaXRpZXM6IFNlcnZlckNhcGFiaWxpdGllcyk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHNlcnZlckNhcGFiaWxpdGllcy5jb2RlQWN0aW9uUHJvdmlkZXIgPT09IHRydWU7XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IFJldHJpZXZlcyBjb2RlIGFjdGlvbnMgZm9yIGEgZ2l2ZW4gZWRpdG9yLCByYW5nZSwgYW5kIGNvbnRleHQgKGRpYWdub3N0aWNzKS5cclxuICAvLyBUaHJvd3MgYW4gZXJyb3IgaWYgY29kZUFjdGlvblByb3ZpZGVyIGlzIG5vdCBhIHJlZ2lzdGVyZWQgY2FwYWJpbGl0eS5cclxuICAvL1xyXG4gIC8vICogYGNvbm5lY3Rpb25gIEEge0xhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbn0gdG8gdGhlIGxhbmd1YWdlIHNlcnZlciB0aGF0IHByb3ZpZGVzIGhpZ2hsaWdodHMuXHJcbiAgLy8gKiBgc2VydmVyQ2FwYWJpbGl0aWVzYCBUaGUge1NlcnZlckNhcGFiaWxpdGllc30gb2YgdGhlIGxhbmd1YWdlIHNlcnZlciB0aGF0IHdpbGwgYmUgdXNlZC5cclxuICAvLyAqIGBlZGl0b3JgIFRoZSBBdG9tIHtUZXh0RWRpdG9yfSBjb250YWluaW5nIHRoZSBkaWFnbm9zdGljcy5cclxuICAvLyAqIGByYW5nZWAgVGhlIEF0b20ge1JhbmdlfSB0byBmZXRjaCBjb2RlIGFjdGlvbnMgZm9yLlxyXG4gIC8vICogYGRpYWdub3N0aWNzYCBBbiB7QXJyYXk8YXRvbUlkZSREaWFnbm9zdGljPn0gdG8gZmV0Y2ggY29kZSBhY3Rpb25zIGZvci5cclxuICAvLyAgICAgICAgICAgICAgICAgVGhpcyBpcyB0eXBpY2FsbHkgYSBsaXN0IG9mIGRpYWdub3N0aWNzIGludGVyc2VjdGluZyBgcmFuZ2VgLlxyXG4gIC8vXHJcbiAgLy8gUmV0dXJucyBhIHtQcm9taXNlfSBvZiBhbiB7QXJyYXl9IG9mIHthdG9tSWRlJENvZGVBY3Rpb259cyB0byBkaXNwbGF5LlxyXG4gIHB1YmxpYyBzdGF0aWMgYXN5bmMgZ2V0Q29kZUFjdGlvbnMoXHJcbiAgICBjb25uZWN0aW9uOiBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24sXHJcbiAgICBzZXJ2ZXJDYXBhYmlsaXRpZXM6IFNlcnZlckNhcGFiaWxpdGllcyxcclxuICAgIGxpbnRlckFkYXB0ZXI6IExpbnRlclB1c2hWMkFkYXB0ZXIgfCB1bmRlZmluZWQgLFxyXG4gICAgZWRpdG9yOiBUZXh0RWRpdG9yLFxyXG4gICAgcmFuZ2U6IFJhbmdlLFxyXG4gICAgZGlhZ25vc3RpY3M6IGF0b21JZGUuRGlhZ25vc3RpY1tdLFxyXG4gICk6IFByb21pc2U8YXRvbUlkZS5Db2RlQWN0aW9uW10+IHtcclxuICAgIGlmIChsaW50ZXJBZGFwdGVyID09IG51bGwpIHtcclxuICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG4gICAgYXNzZXJ0KHNlcnZlckNhcGFiaWxpdGllcy5jb2RlQWN0aW9uUHJvdmlkZXIsICdNdXN0IGhhdmUgdGhlIHRleHREb2N1bWVudC9jb2RlQWN0aW9uIGNhcGFiaWxpdHknKTtcclxuICAgIGNvbnN0IGNvbW1hbmRzID0gYXdhaXQgY29ubmVjdGlvbi5jb2RlQWN0aW9uKHtcclxuICAgICAgdGV4dERvY3VtZW50OiBDb252ZXJ0LmVkaXRvclRvVGV4dERvY3VtZW50SWRlbnRpZmllcihlZGl0b3IpLFxyXG4gICAgICByYW5nZTogQ29udmVydC5hdG9tUmFuZ2VUb0xTUmFuZ2UocmFuZ2UpLFxyXG4gICAgICBjb250ZXh0OiB7XHJcbiAgICAgICAgZGlhZ25vc3RpY3M6IGRpYWdub3N0aWNzLm1hcCgoZGlhZ25vc3RpYykgPT4ge1xyXG4gICAgICAgICAgLy8gUmV0cmlldmUgdGhlIHN0b3JlZCBkaWFnbm9zdGljIGNvZGUgaWYgaXQgZXhpc3RzLlxyXG4gICAgICAgICAgLy8gVW50aWwgdGhlIExpbnRlciBBUEkgcHJvdmlkZXMgYSBwbGFjZSB0byBzdG9yZSB0aGUgY29kZSxcclxuICAgICAgICAgIC8vIHRoZXJlJ3Mgbm8gcmVhbCB3YXkgZm9yIHRoZSBjb2RlIGFjdGlvbnMgQVBJIHRvIGdpdmUgaXQgYmFjayB0byB1cy5cclxuICAgICAgICAgIGNvbnN0IGNvbnZlcnRlZCA9IENvbnZlcnQuYXRvbUlkZURpYWdub3N0aWNUb0xTRGlhZ25vc3RpYyhkaWFnbm9zdGljKTtcclxuICAgICAgICAgIGlmIChkaWFnbm9zdGljLnJhbmdlICE9IG51bGwgJiYgZGlhZ25vc3RpYy50ZXh0ICE9IG51bGwpIHtcclxuICAgICAgICAgICAgY29uc3QgY29kZSA9IGxpbnRlckFkYXB0ZXIuZ2V0RGlhZ25vc3RpY0NvZGUoZWRpdG9yLCBkaWFnbm9zdGljLnJhbmdlLCBkaWFnbm9zdGljLnRleHQpO1xyXG4gICAgICAgICAgICBpZiAoY29kZSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgY29udmVydGVkLmNvZGUgPSBjb2RlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gY29udmVydGVkO1xyXG4gICAgICAgIH0pLFxyXG4gICAgICB9LFxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gY29tbWFuZHMubWFwKChjb21tYW5kKSA9PiAoe1xyXG4gICAgICBhc3luYyBhcHBseSgpIHtcclxuICAgICAgICBhd2FpdCBjb25uZWN0aW9uLmV4ZWN1dGVDb21tYW5kKHtcclxuICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmQuY29tbWFuZCxcclxuICAgICAgICAgIGFyZ3VtZW50czogY29tbWFuZC5hcmd1bWVudHMsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGdldFRpdGxlKCkge1xyXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY29tbWFuZC50aXRsZSk7XHJcbiAgICAgIH0sXHJcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1lbXB0eVxyXG4gICAgICBkaXNwb3NlKCkge30sXHJcbiAgICB9KSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==